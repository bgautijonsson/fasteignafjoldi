---
title: "Fasteignafjöldi Sveitarfélaga"
author: 
    -   name: "Brynjólfur Gauti Guðrúnar Jónsson"
        url: "https://twitter.com/bgautijonsson"
        affiliation: "Tölfræði, Raunvísindadeild Háskóla Íslands"
        affiliation-url: "https://www.hi.is/tolfraedi_0"
date: today
format: 
    html:
        code-fold: true
        toc: true
        toc-location: right
        toc-title: Efnisyfirlit
editor: source
theme: flatly
title-block-banner: true
standalone: true
self-contained: true
---


```{r}
#| include = FALSE


library(pxweb)
library(tidyverse)
library(cowplot)
library(ggthemes)
library(scales)
library(gganimate)
library(lubridate)
library(ggridges)
library(ggtext)
library(rjson)
```

# Gögn

```{r}
d <- read_csv2("fullbuid.csv") |> 
    pivot_longer(c(-Ár), names_to = "sveitarfelag", values_to = "fullbuid") |> 
    janitor::clean_names() |> 
    mutate(sveitarfelag = str_replace(sveitarfelag, "\\.\\.\\.[0-9]+$", "")) |> 
    inner_join(
        read_csv2("ofullbuid.csv") |> 
            pivot_longer(c(-Ár), names_to = "sveitarfelag", values_to = "ofullbuid") |> 
            janitor::clean_names() |> 
            mutate(sveitarfelag = str_replace(sveitarfelag, "\\.\\.\\.[0-9]+$", "")),
        by = c("ar", "sveitarfelag")
    )

mannfjoldi <- pxweb_get(
    url ="https://px.hagstofa.is:443/pxis/api/v1/is/Ibuar/mannfjoldi/2_byggdir/sveitarfelog/MAN02005.px", 
    query = list(
        "Sveitarfélag" = c("*"),
        "Aldur" = c("-1"),
        "Ár" = c("*"),
        "Kyn" = c("0")
    ),
    verbose = FALSE
) |> 
    as.data.frame() |> 
    as_tibble() |> 
    janitor::clean_names() |> 
    rename(mannfjoldi = mannfjoldi_eftir_sveitarfelagi_kyni_og_aldri_1_januar_1998_2022) |> 
    mutate(ar = parse_number(ar)) |> 
    filter(sveitarfelag != "Alls") |> 
    select(sveitarfelag, ar, mannfjoldi) |> 
    mutate(sveitarfelag = fct_recode(sveitarfelag,
                                     "Akureyrarkaupstaður" = "Akureyrarbær"))




fjolskyldur  <- pxweb_get(
    url = "https://px.hagstofa.is:443/pxis/api/v1/is/Ibuar/fjolsk/Fjolskyldan/MAN07108.px",
    query = list(
        "Kjarnafjölskyldur" = c("1"),
        "Sveitarfélag" = c("*"),
        "Ár" =  c("*"),
        "Fjölskyldugerð" = c("*")
    )
) |> 
    as.data.frame() |> 
    as_tibble() |> 
    janitor::clean_names() |> 
    mutate(sveitarfelag = fct_recode(sveitarfelag,
                                     "Reykjavíkurborg" = "Reykjavík",
                                     "Hafnarfjarðarkaupstaður" = "Hafnarfjörður",
                                     "Seltjarnarnesbær" = "Seltjarnarnes",
                                     "Kópavogsbær" = "Kópavogur")) |> 
    semi_join(
        d,
        by = "sveitarfelag"
    ) |> 
    mutate(fjolskyldugerd = fct_collapse(fjolskyldugerd,
                                         "Einhleypt foreldri" = c("Karl með börn", 
                                                                  "Kona með börn"),
                                         "Par með börn" = c("Óvígð sambúð með börnum",
                                                            "Hjónaband með börnum"),
                                         "Par án barna" = c("Óvígð sambúð án barna",
                                                            "Hjónaband án barna"),
                                         "Einstaklingar" = c("Einstaklingar"))) |> 
    count(sveitarfelag, ar, fjolskyldugerd,
          wt = kjarnafjolskyldur_eftir_sveitarfelogum_og_fjolskyldugerd_1998_2022, 
          name = "fjolskyldur") |> 
    mutate(ar = parse_number(ar),
           sveitarfelag = as_factor(sveitarfelag))



d <- d |> 
    inner_join(
        mannfjoldi,
        by = c("sveitarfelag", "ar")
    ) |> 
    inner_join(
        fjolskyldur |> 
            count(sveitarfelag, ar,
                  wt = fjolskyldur, 
                  name = "fjolskyldur"),
        by =  c("sveitarfelag", "ar")
    )


read_data <- function(name) {
    svf <- list(
        "gbr" = "Garðabær",
        "hfj" = "Hafnarfjarðarkaupstaður",
        "kop" = "Kópavogsbær",
        "moso" = "Mosfellsbær",
        "rvk" = "Reykjavíkurborg",
        "seltj" = "Seltjarnarnesbær"
    )
    
    str_c("aldur_", name, ".csv") |> 
        read_csv2() |> 
        inner_join(
            str_c("fyrstukaupendur_", name, ".csv") |> 
                read_csv2(),
            by = "Ár"
        ) |> 
        janitor::clean_names() |> 
        mutate(sveitarfelag = svf[[name]])
}

kaupendur <- c("gbr", "hfj", "moso", "kop", "rvk", "seltj") |> 
    map(read_data) |> 
    reduce(bind_rows)

d <- d |> 
    inner_join(
        kaupendur,
        by = c("ar", "sveitarfelag")
    )



tekjur <- pxweb_get(
    url = "https://px.hagstofa.is:443/pxis/api/v1/is/Samfelag/launogtekjur/3_tekjur/1_tekjur_skattframtol/TEK01002.px",
    query = list(
        "Tekjur og skattar" = c("5"),
        "Eining" = c("2"),
        "Kyn" = c("0"),
        "Sveitarfélag" = c("*"),
        "Ár" =  c("*")
    )
) |> 
    as.data.frame() |> 
    as_tibble() |> 
    janitor::clean_names() |> 
    mutate(sveitarfelag = fct_recode(sveitarfelag,
                                     "Reykjavíkurborg" = "Reykjavík",
                                     "Hafnarfjarðarkaupstaður" = "Hafnarfjörður",
                                     "Seltjarnarnesbær" = "Seltjarnarnes",
                                     "Kópavogsbær" = "Kópavogur"),
           ar = parse_number(ar)) |> 
    semi_join(
        d,
        by = c("sveitarfelag", "ar")
    ) |> 
    select(sveitarfelag, ar, tekjur = tekjur_eftir_sveitarfelogum_og_kyni_sveitarfelagaskipan_1_januar_2021)


d <- d |> 
    left_join(
        tekjur,
        by = c("sveitarfelag", "ar")
    )

```




# Myndir

## Fjölskyldur

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
fjolskyldur |> 
    mutate(fjolskyldugerd = ifelse(fjolskyldugerd == "Einstaklingar", "Einstaklingar", "Annað")) |> 
    count(sveitarfelag, ar, fjolskyldugerd, wt =fjolskyldur) |> 
    group_by(sveitarfelag, ar) |> 
    mutate(p = n / sum(n)) |> 
    ungroup() |> 
    filter(fjolskyldugerd == "Einstaklingar", ar >= 2010) |> 
    ggplot(aes(ar, p)) +
    geom_line(aes(col = sveitarfelag))
```


```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
fjolskyldur |> 
    mutate(fjolskyldugerd = fct_reorder(fjolskyldugerd, fjolskyldur, .fun = max)) |> 
    ggplot(aes(ar, fjolskyldur)) +
    geom_area(aes(fill = fjolskyldugerd), position = "fill") +
    scale_fill_brewer(type = "qual", palette = "Set1") +
    facet_wrap("sveitarfelag", nrow = 2) +
    coord_cartesian(expand = F) +
    theme_half_open() +
    theme(legend.position = "top") +
    labs(fill = NULL)
```


```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat_alls <- d |> 
    filter(ar >= 2010) |> 
    group_by(ar) |> 
    summarise(fjolskyldur = sum(fjolskyldur),
              fullbuid = sum(fullbuid),
              .groups = "drop") |> 
    mutate(fjolskyldur_per_ibud = fjolskyldur / fullbuid,
           x = ar,
           y = fjolskyldur_per_ibud,
           label = "Höfuðborgarsvæðið")

plot_dat <-  d |> 
    filter(ar >= 2010) |> 
    mutate(fjolskyldur_per_ibud = fjolskyldur / fullbuid) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           x = ar,
           y = fjolskyldur_per_ibud,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y ,
                         sveitarfelag == "Kópavogsbær" ~ y - 0.007,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y + 0.006,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y,
                         sveitarfelag == "Seltjarnarnesbær" ~ y,
                         TRUE ~ y))

p <- plot_dat |> 
    ggplot(aes(ar, fjolskyldur_per_ibud)) +
    # geom_line(data = plot_dat_alls, col = "grey50") +
    # geom_point(data = plot_dat_alls, col = "grey50") +
    # geom_text(data = plot_dat_alls |>  filter(ar == max(ar)),
    #           aes(label = label, x = x, y = y), col = "grey50", nudge_x = 0.1, hjust = 0, size = 4) +
    geom_line(aes(col = sveitarfelag)) +
    geom_point(aes(col = sveitarfelag)) +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y, col = label), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe() +
    scale_x_continuous(limits = c(2010, 2024.3),
                       breaks = 2010:2022) +
    scale_y_continuous(labels = label_number(accuracy = 0.01),
                       breaks = c(range(plot_dat$fjolskyldur_per_ibud), 1.2, 1.3, 1.4, 1.5)) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Fjölskyldur á hverja íbúð (sér- og fjölbýli) í sveitarfélögum Höfuðborgarsvæðisins (2010 - 2022)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p,
       filename = "fjolskyldur_per_fasteign.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

## Nýjar íbúðir á mannfjölda

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(nyjar_fullbunar = c(0, diff(fullbuid)) / mannfjoldi * 1000) |> 
    ungroup() |> 
    filter(ar >= 2010, ar < 2022) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           x = ar,
           y = nyjar_fullbunar,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y ,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y,
                         sveitarfelag == "Seltjarnarnesbær" ~ y,
                         TRUE ~ y))


p <- plot_dat |> 
    ggplot(aes(ar, nyjar_fullbunar)) +
    geom_hline(yintercept = 0, lty = 2, alpha = 0.6) +
    geom_line(data = plot_dat |> rename(svf = sveitarfelag), aes(group = svf), col = "grey50", alpha = 0.3, size = 0.5) +
    # geom_point(data = plot_dat |> rename(svf = sveitarfelag), aes(group = svf), col = "grey50", alpha = 0.5) +
    geom_line(aes(col = sveitarfelag)) +
    geom_point(aes(col = sveitarfelag)) +
    # geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
    #           aes(label = label, x = x, y = y, col = label), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe() +
    geom_text(data = tibble(sveitarfelag = "Mosfellsbær",
                            ar = 2014.2,
                            nyjar_fullbunar = 18.9,
                            label = "48.5"),
              aes(col = sveitarfelag, label = label), size = 3.5) +
    metR::geom_arrow(data = tibble(sveitarfelag = "Mosfellsbær",
                                   x = 2014.6, y = 21.5,
                                   dx = 0.35,
                                   dy = 0.5),
                     aes(x = x, y = y, dx = dx, dy = dy, col = sveitarfelag), size = 0.4) +
    scale_x_continuous(limits = c(2010, 2021),
                       breaks = c(2010, 2014, 2018, 2021)) +
    scale_y_continuous(labels = label_number(accuracy = 0.1),
                       breaks = c(range(plot_dat$nyjar_fullbunar), 0, 5, 15, 24.4),
                       limits = c(-1.8, 49),
                       expand = expansion()) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    coord_cartesian(ylim = c(-1.8, 25)) +
    facet_wrap("sveitarfelag") +
    theme_tufte() +
    theme(legend.position = "none", strip.background = element_rect(fill = "grey95")) +
    labs(x = NULL,
         y = NULL,
         title = "Nýjar fullbúnar íbúðir (sér- og fjölbýli) per 1.000 manns í sveitarfélögum Höfuðborgarsvæðisins",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p,
       filename = "nyjar_fullbunar_hofdatolu.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    filter(ar >= 2014) |> 
    group_by(sveitarfelag) |> 
    mutate(nyjar_fullbunar = c(0, diff(fullbuid)) / mannfjoldi * 1000,
           cumsum_nyjar_fullbunar = cumsum(nyjar_fullbunar)) |> 
    ungroup() |> 
    filter(ar >= 2010, ar < 2022) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           x = ar,
           y = cumsum_nyjar_fullbunar,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y ,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y,
                         sveitarfelag == "Seltjarnarnesbær" ~ y,
                         TRUE ~ y))


p <- plot_dat |> 
    ggplot(aes(ar, cumsum_nyjar_fullbunar)) +
    geom_hline(yintercept = 0, lty = 2, alpha = 0.6) +
    geom_line(data = plot_dat |> rename(svf = sveitarfelag), aes(group = svf), col = "grey50", alpha = 0.3, size = 0.5) +
    # geom_point(data = plot_dat |> rename(svf = sveitarfelag), aes(group = svf), col = "grey50", alpha = 0.5) +
    geom_line(aes(col = sveitarfelag)) +
    geom_point(aes(col = sveitarfelag)) +
    # geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
    #           aes(label = label, x = x, y = y, col = label), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe() +
    # geom_text(data = tibble(sveitarfelag = "Mosfellsbær",
    #                         ar = 2014.2,
    #                         nyjar_fullbunar = 18.9,
    #                         label = "48.5"),
    #           aes(col = sveitarfelag, label = label), size = 3.5) +
    # metR::geom_arrow(data = tibble(sveitarfelag = "Mosfellsbær",
    #                                x = 2014.6, y = 21.5,
    #                                dx = 0.35,
    #                                dy = 0.5),
    #                  aes(x = x, y = y, dx = dx, dy = dy, col = sveitarfelag), size = 0.4) +
    scale_x_continuous(limits = c(2014, 2021),
                       breaks = c(2010, 2014, 2018, 2021)) +
    scale_y_continuous(labels = label_number(accuracy = 0.1),
                       breaks = c(range(plot_dat$cumsum_nyjar_fullbunar)),
                       # limits = c(-1.8, 49),
                       expand = expansion()) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    # coord_cartesian(ylim = c(-1.8, 25)) +
    facet_wrap("sveitarfelag") +
    theme_tufte() +
    theme(legend.position = "none", strip.background = element_rect(fill = "grey95")) +
    labs(x = NULL,
         y = NULL,
         title = "Nýjar fullbúnar íbúðir (sér- og fjölbýli) per 1.000 manns í sveitarfélögum Höfuðborgarsvæðisins",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p,
       filename = "uppsafnad_nyjar_fullbunar_hofdatolu.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

### Árleg breyting í íbúðum og fjölskyldum

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
p <- d |> 
    filter(ar >= 2010) |> 
    group_by(sveitarfelag) |> 
    mutate(Fasteignir =  c(1, exp(diff(log(fullbuid)))),
           Fjölskyldur =  c(1, exp(diff(log(fjolskyldur))))) |> 
    ungroup() |> 
    select(-fullbuid, -ofullbuid, -mannfjoldi ,-fjolskyldur) |> 
    pivot_longer(c(-ar, -sveitarfelag)) |> 
    filter(ar >= 2010, ar < 2022) |> 
    ggplot(aes(ar, value)) +
    geom_hline(yintercept = 1, lty = 2, alpha = 0.6) +
    geom_area(aes(fill  = name), alpha = 0.3, position = "identity") +
    geom_line(aes(col = name)) +
    # geom_point(aes(col = name)) +
    # geom_segment(aes(col = name, xend = x, yend = 1)) +
    scale_x_continuous(breaks = c(2010, 2012, 2014, 2016, 2018, 2021)) +
    scale_y_log10(labels = function(x)  percent(x - 1),
                  expand = expansion()) +
    scale_colour_brewer(type = "qual", palette = "Set1") +
    scale_fill_brewer(type = "qual", palette = "Set1") +
    facet_wrap("sveitarfelag", nrow = 2,  scales = "free") +
    theme_half_open() +
    theme(legend.position = "top") +
    labs(title = "Árleg breyting í fjölda íbúða (sér- og fjölbýli) og fjölskyldna í sveitarfélögum Höfuðborgarsvæðisins",
         x = NULL,
         y = NULL,
         fill= NULL,
         col = NULL)

p

ggsave(plot = p,
       filename = "hlutf_breyting_fasteignir_fjolskyldur.png",
       width = 8, height = 0.5 * 8, scale = 2, bg = "white")
```

### Uppsöfnuð

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
p <- d |> 
    group_by(sveitarfelag) |> 
    filter(ar >= 2010) |> 
    mutate(Fasteignir =  c(1, exp(cumsum(diff(log(fullbuid))))),
           Fjölskyldur =  c(1, exp(cumsum(diff(log(fjolskyldur)))))) |> 
    ungroup() |> 
    select(-fullbuid, -ofullbuid, -mannfjoldi, -fjolskyldur) |> 
    pivot_longer(c(-ar, -sveitarfelag)) |> 
    filter(ar >= 2010, ar < 2022) |> 
    ggplot(aes(ar, value)) +
    geom_hline(yintercept = 1, lty = 2, alpha = 0.6) +
    geom_area(aes(fill  = name), alpha = 0.3, position = "identity") +
    geom_line(aes(col = name)) +
    # geom_point(aes(col = name)) +
    # geom_segment(aes(col = name, xend = x, yend = 1)) +
    scale_x_continuous(breaks = c(2010, 2012, 2014, 2016, 2018, 2021)) +
    scale_y_log10(labels = function(x)  percent(x - 1),
                  expand = expansion()) +
    scale_colour_brewer(type = "qual", palette = "Set1") +
    scale_fill_brewer(type = "qual", palette = "Set1") +
    facet_wrap("sveitarfelag", nrow = 2) +
    theme_half_open() +
    theme(legend.position = "top") +
    labs(title = "Uppsöfnuð breyting í fjölda íbúða (sér- og fjölbýli) og fjölskyldna í sveitarfélögum Höfuðborgarsvæðisins",
         x = NULL,
         y = NULL,
         fill= NULL,
         col = NULL)

p

ggsave(plot = p,
       filename = "hlutf_uppsöfnuð_breyting_fasteignir_fjolskyldur.png",
       width = 8, height = 0.5 * 8, scale = 2, bg = "white")
```


## Fasteignafjöldi á íbúa


```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <-  d |> 
    filter(ar >= 2010) |> 
    mutate(fjolskyldur_per_ibud = fjolskyldur / fullbuid) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           x = ar,
           y = fjolskyldur_per_ibud,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y ,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y  - 0.008,
                         sveitarfelag == "Seltjarnarnesbær" ~ y + 0.008,
                         TRUE ~ y))

p <- plot_dat |> 
    ggplot(aes(ar, fjolskyldur_per_ibud)) +
    geom_line(aes(col = sveitarfelag)) +
    geom_point(aes(col = sveitarfelag)) +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y, col = label), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe() +
    scale_x_continuous(limits = c(2010, 2024.3),
                       breaks = 2010:2022) +
    scale_y_continuous(labels = label_number(),
                       breaks = c(range(plot_dat$fjolskyldur_per_ibud), 2.5, 2.75)) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Fjöldi fjölskyldna á íbúð (sér- og fjölbýli) í sveitarfélögum Höfuðborgarsvæðisins (2010 - 2022)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p,
       filename = "fjolskyldur_per_fasteign.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

### Breyting frá 2010

#### Hlutfallsleg

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat_alls <- d |> 
    filter(ar >= 2010) |> 
    group_by(ar) |> 
    summarise(fullbuid = sum(fullbuid),
              fjolskyldur = sum(fjolskyldur),
              .groups = "drop") |> 
    mutate(fjolskyldur_per_ibud = fjolskyldur / fullbuid,
           hlutf_aukning = fjolskyldur_per_ibud / fjolskyldur_per_ibud[ar == min(ar)],
           x = ar,
           y = hlutf_aukning - 0.002,
           label = "Höfuðborgarsvæðið")

plot_dat <-  d |> 
    filter(ar >= 2010) |> 
    mutate(fjolskyldur_per_ibud = fjolskyldur / fullbuid) |> 
    group_by(sveitarfelag) |> 
    mutate(hlutf_aukning = fjolskyldur_per_ibud / fjolskyldur_per_ibud[ar == min(ar)]) |> 
    ungroup() |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           x = ar,
           y = hlutf_aukning,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y ,
                         sveitarfelag == "Kópavogsbær" ~ y + 0.0005,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y,
                         sveitarfelag == "Seltjarnarnesbær" ~ y + 0.002,
                         TRUE ~ y))

p <- plot_dat |> 
    ggplot(aes(ar, hlutf_aukning)) +
    geom_line(data = plot_dat_alls, col = "grey50") +
    geom_point(data = plot_dat_alls, col = "grey50") +
    geom_text(data = plot_dat_alls |>  filter(ar == max(ar)),
              aes(label = label, x = x, y = y), col = "grey50", nudge_x = 0.1, hjust = 0, size = 4) +
    geom_hline(yintercept = 1, lty = 2, alpha = 0.5) +
    geom_line(aes(col = sveitarfelag)) +
    geom_point(aes(col = sveitarfelag)) +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y, col = label), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe() +
    scale_x_continuous(limits = c(2010, 2024.3),
                       breaks = 2010:2022) +
    scale_y_log10(labels = function(x) percent(x - 1),
                  breaks = c(range(plot_dat$hlutf_aukning), 1, 1.05, 1.1, 1.15, 1.2)) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Breyting í fjölda fjölskyldna á íbúð í sveitarfélögum höfuðborgarsvæðisins (2010 - 2022)",
         subtitle = "Fjölskylda getur verið einstaklingur, par með eða án barna, eða einhleypt foreldri og börn",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p,
       filename = "fjolskyldur_a_ibud_hlutf_aukning_2010.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```


### Breyting frá 2018

#### Hlutfallsleg

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat_alls <- d |> 
    filter(ar >= 2018) |> 
    group_by(ar) |> 
    summarise(fullbuid = sum(fullbuid),
              fjolskyldur = sum(fjolskyldur),
              .groups = "drop") |> 
    mutate(fjolskyldur_per_ibud = fjolskyldur / fullbuid,
           hlutf_aukning = fjolskyldur_per_ibud / fjolskyldur_per_ibud[ar == min(ar)],
           x = ar,
           y = hlutf_aukning - 0.002,
           label = "Höfuðborgarsvæðið")

plot_dat <-  d |> 
    filter(ar >= 2018) |> 
    mutate(fjolskyldur_per_ibud = fjolskyldur / fullbuid) |> 
    group_by(sveitarfelag) |> 
    mutate(hlutf_aukning = fjolskyldur_per_ibud / fjolskyldur_per_ibud[ar == min(ar)]) |> 
    ungroup() |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           x = ar,
           y = hlutf_aukning,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y ,
                         sveitarfelag == "Kópavogsbær" ~ y + 0.004,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y + 0.001,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y,
                         sveitarfelag == "Seltjarnarnesbær" ~ y,
                         TRUE ~ y))

p <- plot_dat |> 
    ggplot(aes(ar, hlutf_aukning)) +
    geom_line(data = plot_dat_alls, col = "grey50") +
    geom_point(data = plot_dat_alls, col = "grey50") +
    geom_text(data = plot_dat_alls |>  filter(ar == max(ar)),
              aes(label = label, x = x, y = y), col = "grey50", nudge_x = 0.1, hjust = 0, size = 4) +
    geom_hline(yintercept = 1, lty = 2, alpha = 0.5) +
    geom_line(aes(col = sveitarfelag)) +
    geom_point(aes(col = sveitarfelag)) +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y, col = label), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe() +
    scale_x_continuous(limits = c(2018, 2022.8),
                       breaks = 2018:2022) +
    scale_y_log10(labels = function(x) percent(x - 1),
                  breaks = c(range(plot_dat$hlutf_aukning), 1, 1.05, 1.1, 1.15, 1.2)) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Breyting í fjölda fjölskyldna á íbúð í sveitarfélögum höfuðborgarsvæðisins (2018 - 2022)",
         subtitle = "Fjölskylda getur verið einstaklingur, par með eða án barna, eða einhleypt foreldri og börn",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p,
       filename = "fjolskyldur_a_ibud_hlutf_aukning_2018.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}

plot_dat <-  d |> 
    filter(ar >= 2018) |> 
    mutate(fjoskyldur_per_ibud = fjolskyldur / fullbuid) |> 
    group_by(sveitarfelag) |> 
    mutate(aukning = fjoskyldur_per_ibud / fjoskyldur_per_ibud[ar == min(ar)] - 1) |> 
    ungroup() |> 
    filter(ar == max(ar)) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           x = ar,
           y = aukning,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y ,
                         sveitarfelag == "Kópavogsbær" ~ y - 0.003,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y + 0.004,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y,
                         sveitarfelag == "Seltjarnarnesbær" ~ y,
                         TRUE ~ y)) |> 
    mutate(sveitarfelag1 = fct_reorder(sveitarfelag, aukning))

p <- plot_dat |> 
    ggplot(aes(sveitarfelag1, aukning)) +
    geom_hline(yintercept = 0, lty = 2, alpha = 0.5) +
    geom_col(aes(fill = sveitarfelag)) +
    geom_rangeframe() +
    scale_y_continuous(labels = label_percent(),
                       breaks = c(-0.024, -0.015, 0.005, 0.02, 0.135),
                       expand = expansion(mult = 0.01)) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)) +
    labs(x = NULL,
         y = NULL,
         title = "Breyting í fjölda fjölskyldna á íbúð í sveitarfélögum höfuðborgarsvæðisins (2018 - 2022)",
         subtitle = "Fjölskylda getur verið einstaklingur, par með eða án barna, eða einhleypt foreldri og börn",)

p

ggsave(plot = p,
       filename = "fjolskyldur_a_ibud_hlutf_aukning_2018_cols.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

## Fjölgun fasteigna

### Hrein

```{r}
d |> 
    group_by(sveitarfelag) |> 
    mutate(nyjar_fullbunar = c(0, diff(fullbuid)))
```


```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    filter(ar %in% c(2018, 2022)) |> 
    select(ar, sveitarfelag, fullbuid) |> 
    mutate(ar = ifelse(ar == min(ar), "fyrir", "eftir")) |> 
    pivot_wider(names_from = ar, values_from = fullbuid) |> 
    mutate(aukning = eftir / fyrir - 1) |> 
    mutate(sveitarfelag1 = fct_reorder(sveitarfelag, aukning))

p <- plot_dat |> 
    ggplot(aes(sveitarfelag1, aukning)) +
    # geom_hline(yintercept = 0, lty = 2, alpha = 0.5) +
    geom_col(aes(fill = sveitarfelag)) +
    geom_rangeframe() +
    scale_y_continuous(labels = label_percent(),
                       breaks = c(plot_dat$aukning),
                       expand = expansion(mult = 0)) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)) +
    labs(x = NULL,
         y = NULL,
         title = "Breyting í fjölda íbúða (sér- og fjölbýli) í sveitarfélögum höfuðborgarsvæðisins (2018 - 2022)")

p

ggsave(plot = p,
       filename = "ibudir_hlutf_aukning_2018_cols.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```


### Á fjölskyldu

### Á höfðatölu

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(nyjar_fullbunar = c(0, diff(fullbuid)) / fjolskyldur) |> 
    ungroup() |> 
    filter(ar >= 2010, ar < 2022) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           x = ar,
           y = nyjar_fullbunar,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y ,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y,
                         sveitarfelag == "Seltjarnarnesbær" ~ y,
                         TRUE ~ y))


p <- plot_dat |> 
    ggplot(aes(ar, nyjar_fullbunar)) +
    geom_hline(yintercept = 0, lty = 2, alpha = 0.6) +
    geom_line(data = plot_dat |> rename(svf = sveitarfelag), aes(group = svf), col = "grey50", alpha = 0.3, size = 0.5) +
    # geom_point(data = plot_dat |> rename(svf = sveitarfelag), aes(group = svf), col = "grey50", alpha = 0.5) +
    geom_line(aes(col = sveitarfelag)) +
    geom_point(aes(col = sveitarfelag)) +
    # geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
    #           aes(label = label, x = x, y = y, col = label), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe() +
    geom_text(data = tibble(sveitarfelag = "Mosfellsbær",
                            ar = 2014.2,
                            nyjar_fullbunar = 18.9,
                            label = "48.5"),
              aes(col = sveitarfelag, label = label), size = 3.5) +
    metR::geom_arrow(data = tibble(sveitarfelag = "Mosfellsbær",
                                   x = 2014.6, y = 21.5,
                                   dx = 0.35,
                                   dy = 0.5),
                     aes(x = x, y = y, dx = dx, dy = dy, col = sveitarfelag), size = 0.4) +
    scale_x_continuous(limits = c(2010, 2021),
                       breaks = c(2010, 2014, 2018, 2021)) +
    scale_y_continuous(labels = label_number(accuracy = 0.1),
                       breaks = c(range(plot_dat$nyjar_fullbunar), 0, 5, 15, 24.4),
                       limits = c(-1.8, 49),
                       expand = expansion()) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    coord_cartesian(ylim = c(-1.8, 25)) +
    facet_wrap("sveitarfelag") +
    theme_tufte() +
    theme(legend.position = "none", strip.background = element_rect(fill = "grey95")) +
    labs(x = NULL,
         y = NULL,
         title = "Nýjar fullbúnar íbúðir (sér- og fjölbýli) per 1.000 manns í sveitarfélögum Höfuðborgarsvæðisins",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p,
       filename = "nyjar_fullbunar_hofdatolu.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

### Árleg breyting í íbúðum og íbúum

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
p <- d |> 
    group_by(sveitarfelag) |> 
    mutate(Fasteignir =  c(1, exp(diff(log(fullbuid)))),
           Íbúar =  c(1, exp(diff(log(mannfjoldi))))) |> 
    ungroup() |> 
    select(-fullbuid, -ofullbuid, -mannfjoldi) |> 
    pivot_longer(c(-ar, -sveitarfelag)) |> 
    filter(ar >= 2010, ar < 2022) |> 
    mutate(x = ar - 0.1 + 0.2 * (name == "Fasteignir")) |> 
    ggplot(aes(ar, value)) +
    geom_hline(yintercept = 1, lty = 2, alpha = 0.6) +
    geom_area(aes(fill  = name), alpha = 0.3, position = "identity") +
    geom_line(aes(col = name)) +
    # geom_point(aes(col = name)) +
    # geom_segment(aes(col = name, xend = x, yend = 1)) +
    scale_x_continuous(breaks = c(2010, 2012, 2014, 2016, 2018, 2021)) +
    scale_y_log10(labels = function(x)  percent(x - 1),
                  expand = expansion()) +
    scale_colour_brewer(type = "qual", palette = "Set1") +
    scale_fill_brewer(type = "qual", palette = "Set1") +
    facet_wrap("sveitarfelag", nrow = 2,  scales = "free") +
    theme_half_open() +
    theme(legend.position = "top") +
    labs(title = "Árleg breyting í fjölda íbúða (sér- og fjölbýli) og íbúa í sveitarfélögum Höfuðborgarsvæðisins",
         x = NULL,
         y = NULL,
         fill= NULL,
         col = NULL)

ggsave(plot = p,
       filename = "hlutf_breyting_fasteignir_ibuar.png",
       width = 8, height = 0.5 * 8, scale = 2, bg = "white")
```

### Uppsöfnuð

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
p <- d |> 
    group_by(sveitarfelag) |> 
    filter(ar >= 2010) |> 
    mutate(Fasteignir =  c(1, exp(cumsum(diff(log(fullbuid))))),
           Íbúar =  c(1, exp(cumsum(diff(log(mannfjoldi)))))) |> 
    ungroup() |> 
    select(-fullbuid, -ofullbuid, -mannfjoldi) |> 
    pivot_longer(c(-ar, -sveitarfelag)) |> 
    filter(ar >= 2010, ar < 2022) |> 
    mutate(x = ar - 0.1 + 0.2 * (name == "Fasteignir")) |> 
    ggplot(aes(ar, value)) +
    geom_hline(yintercept = 1, lty = 2, alpha = 0.6) +
    geom_area(aes(fill  = name), alpha = 0.3, position = "identity") +
    geom_line(aes(col = name)) +
    # geom_point(aes(col = name)) +
    # geom_segment(aes(col = name, xend = x, yend = 1)) +
    scale_x_continuous(breaks = c(2010, 2012, 2014, 2016, 2018, 2021)) +
    scale_y_log10(labels = function(x)  percent(x - 1),
                  expand = expansion()) +
    scale_colour_brewer(type = "qual", palette = "Set1") +
    scale_fill_brewer(type = "qual", palette = "Set1") +
    facet_wrap("sveitarfelag", nrow = 2) +
    theme_half_open() +
    theme(legend.position = "top") +
    labs(title = "Uppsöfnuð breyting í fjölda íbúða (sér- og fjölbýli) og íbúa í sveitarfélögum Höfuðborgarsvæðisins",
         x = NULL,
         y = NULL,
         fill= NULL,
         col = NULL)

p

ggsave(plot = p,
       filename = "hlutf_uppsöfnuð_breyting_fasteignir_ibuar.png",
       width = 8, height = 0.5 * 8, scale = 2, bg = "white")
```


## Fasteignafjöldi á íbúa


```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat_alls <- d |> 
    filter(ar >= 2010) |> 
    group_by(ar) |> 
    summarise(fullbuid = sum(fullbuid),
              mannfjoldi = sum(mannfjoldi),
              .groups = "drop") |> 
    mutate(ibuar_per_ibud = mannfjoldi / fullbuid,
           x = ar,
           y = ibuar_per_ibud,
           label = "Höfuðborgarsvæðið")

plot_dat <-  d |> 
    filter(ar >= 2010) |> 
    mutate(ibuar_per_ibud = mannfjoldi / fullbuid) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           x = ar,
           y = ibuar_per_ibud,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y ,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y  - 0.008,
                         sveitarfelag == "Seltjarnarnesbær" ~ y + 0.008,
                         TRUE ~ y))

p <- plot_dat |> 
    ggplot(aes(ar, ibuar_per_ibud)) +
    geom_line(data = plot_dat_alls, col = "grey50") +
    geom_point(data = plot_dat_alls, col = "grey50") +
    geom_text(data = plot_dat_alls |>  filter(ar == max(ar)),
              aes(label = label, x = x, y = y), col = "grey50", nudge_x = 0.1, hjust = 0, size = 4) +
    geom_line(aes(col = sveitarfelag)) +
    geom_point(aes(col = sveitarfelag)) +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y, col = label), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe() +
    scale_x_continuous(limits = c(2010, 2024.3),
                       breaks = 2010:2022) +
    scale_y_continuous(labels = label_number(),
                       breaks = c(range(plot_dat$ibuar_per_ibud), 2.5, 2.75)) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Meðalfjöldi íbúa í íbúðum (sér- og fjölbýli) sveitarfélaga Höfuðborgarsvæðisins (2010 - 2022)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p,
       filename = "manneskjur_per_fasteign.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

### Breyting frá 2010

#### Hlutfallsleg

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat_alls <- d |> 
    filter(ar >= 2010) |> 
    group_by(ar) |> 
    summarise(fullbuid = sum(fullbuid),
              mannfjoldi = sum(mannfjoldi),
              .groups = "drop") |> 
    mutate(fullbuid_per_ibui = fullbuid / mannfjoldi * 1000,
           hlutf_aukning = fullbuid_per_ibui / fullbuid_per_ibui[ar == min(ar)],
           x = ar,
           y = hlutf_aukning,
           label = "Höfuðborgarsvæðið")

plot_dat <-  d |> 
    filter(ar >= 2010) |> 
    mutate(fullbuid_per_ibui = fullbuid / mannfjoldi) |> 
    group_by(sveitarfelag) |> 
    mutate(hlutf_aukning = fullbuid_per_ibui / fullbuid_per_ibui[ar == min(ar)]) |> 
    ungroup() |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           x = ar,
           y = hlutf_aukning,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y ,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y + 0.0023,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y,
                         sveitarfelag == "Seltjarnarnesbær" ~ y - 0.002,
                         TRUE ~ y))

p <- plot_dat |> 
    ggplot(aes(ar, hlutf_aukning)) +
    geom_line(data = plot_dat_alls, col = "grey50") +
    geom_point(data = plot_dat_alls, col = "grey50") +
    geom_text(data = plot_dat_alls |>  filter(ar == max(ar)),
              aes(label = label, x = x, y = y), col = "grey50", nudge_x = 0.1, hjust = 0, size = 4) +
    geom_hline(yintercept = 1, lty = 2, alpha = 0.5) +
    geom_line(aes(col = sveitarfelag)) +
    geom_point(aes(col = sveitarfelag)) +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y, col = label), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe() +
    scale_x_continuous(limits = c(2010, 2024.3),
                       breaks = 2010:2022) +
    scale_y_continuous(labels = function(x) percent(x - 1),
                       breaks = c(range(plot_dat$hlutf_aukning), 0.95, 1, 1.05)) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Breyting í fjölda fasteigna á höfðatölu í sveitarfélögum höfuðborgarsvæðisins (2010 - 2022)",
         subtitle = "Líka borið saman við aukningu á Höfuðborgarsvæðinu í heild",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p,
       filename = "fasteignir_a_mannfjolda_hlutf_aukning_2010.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```


### Breyting frá 2018

#### Hlutfallsleg

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat_alls <- d |> 
    filter(ar >= 2018) |> 
    group_by(ar) |> 
    summarise(fullbuid = sum(fullbuid),
              mannfjoldi = sum(mannfjoldi),
              .groups = "drop") |> 
    mutate(fullbuid_per_ibui = fullbuid / mannfjoldi * 1000,
           hlutf_aukning = fullbuid_per_ibui / fullbuid_per_ibui[ar == min(ar)],
           x = ar,
           y = hlutf_aukning - 0.001,
           label = "Höfuðborgarsvæðið")

plot_dat <-  d |> 
    filter(ar >= 2018) |> 
    mutate(fullbuid_per_ibui = fullbuid / mannfjoldi) |> 
    group_by(sveitarfelag) |> 
    mutate(hlutf_aukning = fullbuid_per_ibui / fullbuid_per_ibui[ar == min(ar)]) |> 
    ungroup() |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           x = ar,
           y = hlutf_aukning,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y ,
                         sveitarfelag == "Kópavogsbær" ~ y - 0.003,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y + 0,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y,
                         sveitarfelag == "Seltjarnarnesbær" ~ y,
                         TRUE ~ y))

p <- plot_dat |> 
    ggplot(aes(ar, hlutf_aukning)) +
    # geom_line(data = plot_dat_alls, col = "grey50") +
    # geom_point(data = plot_dat_alls, col = "grey50") +
    # geom_text(data = plot_dat_alls |>  filter(ar == max(ar)),
    #           aes(label = label, x = x, y = y), col = "grey50", nudge_x = 0.1, hjust = 0, size = 4) +
    geom_hline(yintercept = 1, lty = 2, alpha = 0.5) +
    geom_line(aes(col = sveitarfelag)) +
    geom_point(aes(col = sveitarfelag)) +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y, col = label), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe() +
    scale_x_continuous(limits = c(2018, 2022.9),
                       breaks = 2010:2022) +
    scale_y_continuous(labels = function(x) percent(x - 1),
                       breaks = c(range(plot_dat$hlutf_aukning), 0.95, 1, 1.05)) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Hlutfallsleg breyting í fjölda fasteigna á höfðatölu í sveitarfélögum höfuðborgarsvæðisins (2018 - 2022)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p,
       filename = "fasteignir_a_mannfjolda_hlutf_aukning_2018.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}

plot_dat <-  d |> 
    filter(ar >= 2018) |> 
    mutate(fullbuid_per_ibui = fullbuid / mannfjoldi * 1000) |> 
    group_by(sveitarfelag) |> 
    mutate(aukning = fullbuid_per_ibui / fullbuid_per_ibui[ar == min(ar)] - 1) |> 
    ungroup() |> 
    filter(ar == max(ar)) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           x = ar,
           y = aukning,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y ,
                         sveitarfelag == "Kópavogsbær" ~ y - 0.003,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y + 0.004,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y,
                         sveitarfelag == "Seltjarnarnesbær" ~ y,
                         TRUE ~ y)) |> 
    mutate(sveitarfelag1 = fct_reorder(sveitarfelag, aukning))

p <- plot_dat |> 
    ggplot(aes(sveitarfelag1, aukning)) +
    geom_hline(yintercept = 0, lty = 2, alpha = 0.5) +
    geom_col(aes(fill = sveitarfelag)) +
    geom_rangeframe() +
    scale_y_continuous(labels = label_percent(),
                       breaks = c(plot_dat$aukning),
                       expand = expansion(mult = 0.01)) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)) +
    labs(x = NULL,
         y = NULL,
         title = "Breyting í fjölda fasteigna á höfðatölu í sveitarfélögum höfuðborgarsvæðisins (2018 - 2022)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "fasteignir_a_mannfjolda_hlutf_aukning_2018_cols.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Hrein

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat_alls <- d |> 
    filter(ar >= 2018) |> 
    group_by(ar) |> 
    summarise(fullbuid = sum(fullbuid),
              mannfjoldi = sum(mannfjoldi),
              .groups = "drop") |> 
    mutate(fullbuid_per_ibui = fullbuid / mannfjoldi * 1000,
           aukning = fullbuid_per_ibui - fullbuid_per_ibui[ar == min(ar)],
           x = ar,
           y = aukning - 0.001,
           label = "Höfuðborgarsvæðið")

plot_dat <-  d |> 
    filter(ar >= 2018) |> 
    mutate(fullbuid_per_ibui = fullbuid / mannfjoldi * 1000) |> 
    group_by(sveitarfelag) |> 
    mutate(aukning = fullbuid_per_ibui - fullbuid_per_ibui[ar == min(ar)]) |> 
    ungroup() |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           x = ar,
           y = aukning,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y ,
                         sveitarfelag == "Kópavogsbær" ~ y - 0.015,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y + 0.001,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y,
                         sveitarfelag == "Seltjarnarnesbær" ~ y,
                         TRUE ~ y))

p <- plot_dat |> 
    ggplot(aes(ar, aukning)) +
    # geom_line(data = plot_dat_alls, col = "grey50") +
    # geom_point(data = plot_dat_alls, col = "grey50") +
    # geom_text(data = plot_dat_alls |>  filter(ar == max(ar)),
    #           aes(label = label, x = x, y = y), col = "grey50", nudge_x = 0.05, hjust = 0, size = 4) +
    geom_hline(yintercept = 0, lty = 2, alpha = 0.5) +
    geom_line(aes(col = sveitarfelag)) +
    geom_point(aes(col = sveitarfelag)) +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y, col = label), nudge_x = 0.05, hjust = 0, size = 4) +
    geom_rangeframe() +
    scale_x_continuous(limits = c(2018, 2022.75),
                       breaks = 2010:2022) +
    scale_y_continuous(labels = label_number(),
                       breaks = c(range(plot_dat$aukning), -20, 0)) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Breyting á fjölda fasteigna á 1.000 íbúa í sveitarfélögum höfuðborgarsvæðisins (2018 - 2022)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p,
       filename = "fasteignir_a_mannfjolda_aukning_2018.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```


```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat_alls <- d |> 
    filter(ar >= 2018) |> 
    group_by(ar) |> 
    summarise(fullbuid = sum(fullbuid),
              mannfjoldi = sum(mannfjoldi),
              .groups = "drop") |> 
    mutate(fullbuid_per_ibui = fullbuid / mannfjoldi * 1000,
           aukning = fullbuid_per_ibui / fullbuid_per_ibui[ar == min(ar)],
           x = ar,
           y = aukning - 0.001,
           label = "Höfuðborgarsvæðið",
           sveitarfelag = label) |> 
    filter(ar == max(ar))

plot_dat <-  d |> 
    filter(ar >= 2018) |> 
    mutate(fullbuid_per_ibui = fullbuid / mannfjoldi * 1000) |> 
    group_by(sveitarfelag) |> 
    mutate(aukning = fullbuid_per_ibui - fullbuid_per_ibui[ar == min(ar)]) |> 
    ungroup() |> 
    filter(ar == max(ar)) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           x = ar,
           y = aukning,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y ,
                         sveitarfelag == "Kópavogsbær" ~ y - 0.003,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y + 0.004,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y,
                         sveitarfelag == "Seltjarnarnesbær" ~ y,
                         TRUE ~ y)) |> 
    mutate(sveitarfelag1 = fct_reorder(sveitarfelag, aukning))

p <- plot_dat |> 
    ggplot(aes(sveitarfelag1, aukning)) +
    geom_hline(yintercept = 0, lty = 2, alpha = 0.5) +
    geom_col(aes(fill = sveitarfelag)) +
    geom_rangeframe() +
    scale_y_continuous(labels = label_number(),
                       breaks = c(round(plot_dat$aukning))) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)) +
    labs(x = NULL,
         y = NULL,
         title = "Breyting í fjölda fasteigna á höfðatölu í sveitarfélögum höfuðborgarsvæðisins (2018 - 2022)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "fasteignir_a_mannfjolda_aukning_2018_cols.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```


## Ófullbúið

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    filter(ar >= 2010) |> 
    mutate(hlutf = ofullbuid / mannfjoldi * 1000) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           x = ar,
           y = hlutf,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y  - 0.5,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y + 0.5,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y,
                         sveitarfelag == "Seltjarnarnesbær" ~ y,
                         TRUE ~ y))

p <- plot_dat |> 
    ggplot(aes(ar, hlutf)) +
    geom_line(aes(col = sveitarfelag)) +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y, col = label), nudge_x = 0.05, hjust = 0, size = 4) +
    geom_rangeframe() + 
    scale_x_continuous(limits = c(2010, 2024.1),
                       breaks = 2010:2022) +
    scale_y_continuous(labels = label_number(accuracy = 1),
                       breaks = c(range(plot_dat$hlutf), 10, 20, 30, 40)) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Ófullbúnar íbúðir á 1.000 íbúa sveitarfélaga höfuðborgarsvæðisins")

p

ggsave(plot = p,
       filename = "ofullbunar_a_mannfjolda.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

# Fyrstu kaupendur

```{r}
read_data <- function(name) {
    svf <- list(
        "gbr" = "Garðabær",
        "hfj" = "Hafnarfjarðarkaupstaður",
        "kop" = "Kópavogsbær",
        "moso" = "Mosfellsbær",
        "rvk" = "Reykjavíkurborg",
        "seltj" = "Seltjarnarnesbær"
    )
    
    str_c("hlutf_arsfj_", name, ".csv") |> 
        read_csv2() |> 
        janitor::clean_names() |> 
        mutate(sveitarfelag = svf[[name]])
}


hlutf <- c("gbr", "hfj", "moso", "kop", "rvk", "seltj") |> 
    map(read_data) |> 
    reduce(bind_rows) |> 
    separate(arsfjordungur, into = c("ar", "fj"), sep = "-") |> 
    mutate(fj = parse_number(fj),
           fj = 1 + (fj - 1) * 3,
           fj = str_pad(fj, width = 2, side = "left", pad = "0"),
           dags = str_c(ar, "-", fj, "-01") |> ymd()) |> 
    select(dags, sveitarfelag, hlutfall_fyrstu_kaupenda)
```



## Hlutfall

### Ársfjórðungar

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- hlutf |> 
    mutate(ar = year(dags)) |> 
    filter(ar >= 2010) |> 
    mutate(hlutfall_fyrstu_kaupenda = hlutfall_fyrstu_kaupenda / 100)

p <- plot_dat |> 
    ggplot(aes(dags, hlutfall_fyrstu_kaupenda)) +
    geom_line(data = plot_dat |> rename(svf = sveitarfelag),
              aes(group = svf),
              alpha = 0.6, col = "grey50") +
    geom_line(aes(col = sveitarfelag), size = 1.2) + 
    geom_rangeframe() +
    scale_x_date(breaks = seq.Date(from = ymd("2010-01-01"), to = ymd("2022-01-01"), 
                                   by = "year"),
                 date_labels = "%Y") +
    scale_y_continuous(labels = label_percent(),
                       breaks = c(0.1, 0.2, 0.3, 0.4),
                       limits = c(0, 0.5),
                       expand = expansion()) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    facet_wrap("sveitarfelag") +
    theme_tufte() +
    theme(legend.position = "none",
          strip.background = element_rect(colour = NA, fill = "grey90")) +
    labs(x = NULL,
         y = NULL,
         title = "Hvar kaupa fyrstu kaupendur sér helst íbúð?",
         subtitle = "Hlutfall fyrstu kaupenda af öllum kaupendum eftir ársfjórðungi og sveitarfélagi Höfuðborgarsvæðis",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p,
       filename = "hlutfall_fyrstu_kaupenda_arsfj.png",
       width = 8, height = 0.5 * 8, scale = 1.7, bg = "white")

```

### Ár

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    filter(ar >= 2010) |> 
    mutate(hlutfall_fyrstu_kaupenda = hlutfall_fyrstu_kaupenda / 100)

p <- plot_dat |> 
    ggplot(aes(ar, hlutfall_fyrstu_kaupenda)) +
    geom_line(data = plot_dat |> rename(svf = sveitarfelag),
              aes(group = svf),
              alpha = 0.6, col = "grey50") +
    geom_line(aes(col = sveitarfelag), size = 1.2) + 
    geom_rangeframe() +
    scale_x_continuous(breaks = 2010:2022, 
                       expand = expansion(), 
                       limits = c(2009.5, 2022.5)) +
    scale_y_continuous(labels = label_percent(),
                       breaks = c(0.1, 0.2, 0.3, 0.4),
                       limits = c(0.1, 0.4),
                       expand = expansion()) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    facet_wrap("sveitarfelag") +
    theme_tufte() +
    theme(legend.position = "none",
          strip.background = element_rect(colour = NA, fill = "grey90")) +
    labs(x = NULL,
         y = NULL,
         title = "Hvar er hlutfall fyrstu kaupenda hæst?",
         subtitle = "Hlutfall fyrstu kaupenda af öllum kaupendum eftir ári og sveitarfélagi Höfuðborgarsvæðis",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p,
       filename = "hlutfall_fyrstu_kaupenda.png",
       width = 8, height = 0.5 * 8, scale = 1.7, bg = "white")

```


## Aldur

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    filter(ar >= 2010)

p <- plot_dat |> 
    ggplot(aes(ar, fyrstu_kaupendur)) +
    geom_line(data = plot_dat |> rename(svf = sveitarfelag),
              aes(group = svf),
              alpha = 0.6, col = "grey50") +
    geom_line(aes(col = sveitarfelag), size = 1.2) + 
    geom_rangeframe() +
    scale_x_continuous(breaks = 2010:2022, 
                       expand = expansion(), 
                       limits = c(2009.5, 2022.5)) +
    scale_y_continuous() +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    facet_wrap("sveitarfelag") +
    theme_tufte() +
    theme(legend.position = "none",
          strip.background = element_rect(colour = NA, fill = "grey90")) +
    labs(x = NULL,
         y = NULL,
         title = "Hvar eru fyrstu kaupendur yngst?",
         subtitle = "Meðalaldur fyrstu kaupenda eftir ári og sveitarfélagi Höfuðborgarsvæðis",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p


ggsave(plot = p,
       filename = "aldur_fyrstu_kaupenda.png",
       width = 8, height = 0.5 * 8, scale = 1.7, bg = "white")

```

### Tekjur

```{r}
plot_dat <- d |> 
    filter(ar >= 2010) |> 
    inner_join(
        visitala,
        by = "ar"
    ) |> 
    group_by(ar) |> 
    mutate(tekjur = tekjur / tekjur[sveitarfelag == "Reykjavíkurborg"])

p <- plot_dat |> 
    ggplot(aes(ar, tekjur)) +
    geom_line(data = plot_dat |> rename(svf = sveitarfelag),
              aes(group = svf),
              alpha = 0.6, col = "grey50") +
    geom_line(aes(col = sveitarfelag), size = 1.2) + 
    geom_rangeframe() +
    scale_x_continuous(breaks = 2010:2022, 
                       expand = expansion(), 
                       limits = c(2009.5, 2022.5)) +
    scale_y_log10(labels = function(x) percent(x - 1)) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    facet_wrap("sveitarfelag") +
    theme_tufte() +
    theme(legend.position = "none",
          strip.background = element_rect(colour = NA, fill = "grey90")) +
    labs(x = NULL,
         y = NULL,
         title = "Hvar eru tekjur hæstar?",
         subtitle = "Miðgildi ráðstöfunartekna borið saman við Reykjavíkurborg eftir ári og sveitarfélagi Höfuðborgarsvæðis",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p,
       filename = "tekjur.png",
       width = 8, height = 0.5 * 8, scale = 1.7, bg = "white")
```


# Kaupskra

```{r}
kaupskra <- read_csv2("https://www.skra.is/library/Skrar/kaupskra/kaupskra.csv", locale = locale(encoding = "ISO-8859-1")) |> 
    semi_join(d,
              by = "sveitarfelag") |> 
    filter(tegund %in% c("Serbyli", "Fjolbyli"),
           onothaefur_samningur == 0)


visitala <- read_csv2("visitala_ibudarverds.csv") |> 
    janitor::clean_names() |> 
    filter(str_detect(manudur, "Janúar")) |> 
    mutate(ar = parse_number(manudur)) |> 
    mutate(visitala = allt_ibudarhusnaedi / allt_ibudarhusnaedi[ar == 2022]) |>
    select(ar, visitala)
```


## Kaupverð nýrra íbúða

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- kaupskra |> 
    mutate(utgdag = as_date(utgdag),
           ar = year(utgdag),
           fullbuid == 1) |> 
    filter(byggar >= 2014) |> 
    select(utgdag, ar, sveitarfelag, kaupverd, fastnum) |> 
    mutate(kaupverd = kaupverd / 1000) |> 
    group_by(fastnum) |> 
    filter(utgdag == min(utgdag)) |> 
    group_by(sveitarfelag) |> 
    mutate(n_fastnum = n()) |> 
    ungroup() |> 
    mutate(sveitarfelag = str_c("<b>", sveitarfelag, "</b>", "<br>", "(Fasteignir = ", n_fastnum, ")")) |> 
    inner_join(visitala,
               by = "ar") |> 
    mutate(kaupverd = kaupverd / visitala)

my_fun <- function(x) {
    plot_dat |> 
        filter(sveitarfelag != x) |> 
        mutate(sveitarfelag = x)
}

plot_dat_compare <- map(unique(plot_dat$sveitarfelag), my_fun) |> 
    reduce(bind_rows)

p <- plot_dat |> 
    ggplot() + 
    geom_histogram(mapping = aes(x = kaupverd, y = ..ncount.., 
                                 color = sveitarfelag, fill = sveitarfelag), 
                   stat = "bin", bins = 40, size = 0.5,
                   alpha = 0.7) + 
    geom_step(data = plot_dat |> rename(svf = sveitarfelag), 
              mapping = aes(x = kaupverd, y = ..ncount..), 
              inherit.aes = FALSE,
              bins = 40, alpha = 0.9,
              color = "gray30", size = 0.6,
              stat = "bin",
              direction = "mid") + 
    # geom_rangeframe(sides = "b") +
    scale_x_log10(labels = label_number(suffix = " mkr")) +
    scale_y_continuous(expand = expansion(),
                       limits = c(0, 1.01)) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    guides(color = "none", fill = "none") + 
    labs(x = NULL, y = NULL, 
         title = "Dreifing kaupverðs nýrra íbúða (sér- og fjölbýli) í sveitarfélögum Höfuðborgarsvæðisin.", 
         subtitle = "Dreifing fyrir Höfuðborgarsvæðið í heild sinni sýnd til viðmiðunar. Sýnt fyrir íbúðir byggðar 2014 - 2022.",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi") + 
    facet_wrap(~ sveitarfelag, nrow = 2, scales = "free_x") +
    theme_tufte() +
    theme(strip.background = element_rect( fill = "grey95"),
          strip.text = element_markdown(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          plot.title = element_text(face = "bold"))

p

ggsave(plot = p,
       filename = "dreifing_kaupverds.png",
       width = 8, height = 0.5 * 8, scale = 1.7, bg = "white")
```

## Fermetraverð nýrra íbúða

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- kaupskra |> 
    mutate(utgdag = dmy_hm(utgdag),
           ar = year(utgdag),
           fullbuid == 1) |> 
    filter(byggar >= 2014) |> 
    select(utgdag, ar, sveitarfelag, kaupverd, fastnum, einflm) |> 
    mutate(kaupverd = kaupverd / einflm) |> 
    group_by(fastnum) |> 
    filter(utgdag == min(utgdag)) |> 
    group_by(sveitarfelag) |> 
    mutate(n_fastnum = n()) |> 
    ungroup() |> 
    mutate(sveitarfelag = str_c("<b>", sveitarfelag, "</b>", "<br>", "(Fasteignir = ", n_fastnum, ")")) |> 
    inner_join(visitala,
               by = "ar") |> 
    mutate(kaupverd = kaupverd / visitala)

my_fun <- function(x) {
    plot_dat |> 
        filter(sveitarfelag != x) |> 
        mutate(sveitarfelag = x)
}

plot_dat_compare <- map(unique(plot_dat$sveitarfelag), my_fun) |> 
    reduce(bind_rows)

p <- plot_dat |> 
    ggplot() + 
    geom_histogram(mapping = aes(x = kaupverd, y = ..ncount.., 
                                 color = sveitarfelag, fill = sveitarfelag), 
                   stat = "bin", bins = 40, size = 0.5,
                   alpha = 0.7) + 
    geom_step(data = plot_dat |> rename(svf = sveitarfelag), 
              mapping = aes(x = kaupverd, y = ..ncount..), 
              inherit.aes = FALSE,
              bins = 40, alpha = 0.9,
              color = "gray30", size = 0.6,
              stat = "bin",
              direction = "mid") + 
    # geom_rangeframe(sides = "b") +
    scale_x_log10(labels = label_number(suffix = " þús kr")) +
    scale_y_continuous(expand = expansion(),
                       limits = c(0, 1.01)) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    guides(color = "none", fill = "none") + 
    labs(x = NULL, y = NULL, 
         title = "Dreifing fermetraverðs nýrra íbúða (sér- og fjölbýli) í sveitarfélögum Höfuðborgarsvæðisin.", 
         subtitle = "Dreifing fyrir Höfuðborgarsvæðið í heild sinni sýnd til viðmiðunar. Sýnt fyrir íbúðir byggðar 2014 - 2022.",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi") + 
    facet_wrap(~ sveitarfelag, nrow = 2, scales = "free_x") +
    theme_tufte() +
    theme(strip.background = element_rect( fill = "grey95"),
          strip.text = element_markdown(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          plot.title = element_text(face = "bold"))

p

ggsave(plot = p,
       filename = "dreifing_kaupverds_per_fm.png",
       width = 8, height = 0.5 * 8, scale = 1.7, bg = "white")
```



```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- kaupskra |> 
    mutate(utgdag = dmy_hm(utgdag),
           ar = year(utgdag),
           fullbuid == 1) |> 
    filter(ar >= 2014) |> 
    select(utgdag, ar, sveitarfelag, kaupverd, fasteignamat, fastnum) |> 
    mutate(hlutf = kaupverd / fasteignamat) |> 
    filter(hlutf <= 3, hlutf >= 1/3,
           fasteignamat >= 30000, fasteignamat <= 100000)

my_fun <- function(x) {
    plot_dat |> 
        filter(sveitarfelag != x) |> 
        mutate(sveitarfelag = x)
}

plot_dat_compare <- map(unique(plot_dat$sveitarfelag), my_fun) |> 
    reduce(bind_rows)

p <- plot_dat |> 
    ggplot() + 
    geom_histogram(mapping = aes(x = hlutf, y = ..ncount.., 
                                 color = sveitarfelag, fill = sveitarfelag), 
                   stat = "bin", bins = 40, size = 0.5,
                   alpha = 0.7) + 
    geom_step(data = plot_dat_compare, 
              mapping = aes(x = hlutf, y = ..ncount..), 
              inherit.aes = FALSE,
              bins = 40, alpha = 0.9,
              color = "gray30", size = 0.6,
              stat = "bin",
              direction = "mid") + 
    # geom_rangeframe(sides = "b") +
    scale_x_log10(labels = function(x) percent(x - 1)) +
    scale_y_continuous(expand = expansion(),
                       limits = c(0, 1.01)) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    guides(color = "none", fill = "none") + 
    labs(x = NULL, y = NULL) + 
    facet_wrap(~ sveitarfelag, nrow = 2, scales = "free_x") +
    theme_tufte() +
    theme(strip.background = element_rect( fill = "grey95"),
          strip.text = element_markdown(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          plot.title = element_text(face = "bold"))

p

# ggsave(plot = p,
#        filename = "dreifing_kaupverds.png",
#        width = 8, height = 0.5 * 8, scale = 1.7, bg = "white")
```

## Munur á kaupverði og fasteignamati

### Eftir ári

```{r, fig.asp = 1, fig.width = 10, out.width = "100%"}
plot_dat <- kaupskra |> 
    mutate(utgdag = as_date(utgdag),
           ar = year(utgdag),
           dags = floor_date(utgdag, unit = "quarter")) |> 
    filter(fullbuid == 1) |>
    mutate(hlutf = kaupverd / fasteignamat,
           tegund = ifelse(tegund == "Fjolbyli", "Fjölbýli", "Sérbýli")) |> 
    group_by(tegund, ar, sveitarfelag) |> 
    summarise(hlutf = median(hlutf),
              .groups = "drop")


p <- plot_dat |> 
    ggplot(aes(ar, hlutf)) +
    geom_hline(yintercept = 1, lty = 2, alpha = 0.6) +
    geom_line(data = plot_dat |> rename(svf = sveitarfelag, teg = tegund), 
              aes(group = paste(svf, teg)), alpha = 0.4, col = "grey50") +
    geom_line(aes(col = sveitarfelag), size = 1.5) +
    geom_rangeframe(sides = "b", aes(alpha = (sveitarfelag == "Seltjarnarnesbær"))) +
    scale_x_continuous(breaks = c(2006, 2010, 2014, 2018, 2022)) +
    scale_y_log10(labels = function(x) percent(x - 1), breaks = c(1, 1.1, 1.2, 1.3, 1.4)) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    scale_alpha_manual(values = c(0, 1)) +
    facet_grid(sveitarfelag ~ tegund) +
    theme_tufte() +
    theme(legend.position = "none",
          strip.background = element_rect( fill = "grey95"),
          plot.title = element_text(face = "bold")) +
    labs(x = NULL,
         y = NULL,
         title = "Hversu miklu hærra hefur kaupverð verið en fasteignamat?",
         subtitle = "Miðgildi fyrir hlutfallslegan mun sýnt fyrir sveitarfélög Höfuðborgarsvæðisins",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p,
       filename = "kaupverd_hlutf_fasteignamat.png",
       width = 8, height = 1 * 8, scale = 1.3, bg = "white")
```

### Eftir ársfjórðungi

```{r, fig.asp = 1, fig.width = 10, out.width = "100%"}
plot_dat <- kaupskra |> 
    mutate(utgdag = as_date(utgdag),
           ar = year(utgdag),
           dags = floor_date(utgdag, unit = "quarter") |> as_date()) |> 
    filter(ar >= 2014, fullbuid == 1) |> 
    # filter(ar >= 2000) |> 
    mutate(hlutf = kaupverd / fasteignamat,
           tegund = ifelse(tegund == "Fjolbyli", "Fjölbýli", "Sérbýli")) |> 
    group_by(tegund, dags, sveitarfelag) |> 
    summarise(hlutf = median(hlutf),
              .groups = "drop")


p <- plot_dat |> 
    ggplot(aes(dags, hlutf)) +
    geom_hline(yintercept = 1, lty = 2, alpha = 0.6) +
    geom_line(data = plot_dat |> rename(svf = sveitarfelag, teg = tegund), 
              aes(group = paste(svf, teg)), alpha = 0.4, col = "grey50") +
    geom_line(aes(col = sveitarfelag), size = 1.5) +
    geom_rangeframe(sides = "b", aes(alpha = (sveitarfelag == "Seltjarnarnesbær"))) +
    scale_x_date(breaks = seq.Date(from = ymd("2014-01-01"), to = ymd("2022-01-01"), by = "12 month"),
                 date_labels = "%Y", guide = guide_axis(n.dodge = 1)) +
    scale_y_continuous(labels = function(x) percent(x - 1), breaks = c(1, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6)) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    scale_alpha_manual(values = c(0, 1)) +
    facet_grid(sveitarfelag ~ tegund) +
    coord_cartesian(ylim = c(0.9, 1.6)) +
    theme_tufte() +
    theme(legend.position = "none",
          strip.background = element_rect( fill = "grey95"),
          plot.title = element_text(face = "bold")) +
    labs(x = NULL,
         y = NULL,
         title = "Hversu miklu hærra hefur kaupverð verið en fasteignamat?",
         subtitle = "Ársfjórðungslegt miðgildi fyrir hlutfallslegan mun sýnt fyrir sveitarfélög Höfuðborgarsvæðisins",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p,
       filename = "kaupverd_hlutf_fasteignamat_arsfjordung.png",
       width = 8, height = 1 * 8, scale = 1.3, bg = "white")
```




### Eftir mánuði

```{r, fig.asp = 1, fig.width = 10, out.width = "100%"}
plot_dat <- kaupskra |> 
    mutate(utgdag = as_date(utgdag),
           ar = year(utgdag),
           dags = floor_date(utgdag, unit = "month") |> as_date()) |> 
    filter(ar >= 2014) |> 
    # filter(ar >= 2000) |> 
    mutate(hlutf = kaupverd / fasteignamat,
           tegund = ifelse(tegund == "Fjolbyli", "Fjölbýli", "Sérbýli")) |> 
    group_by(tegund, dags, sveitarfelag) |> 
    summarise(hlutf = median(hlutf),
              .groups = "drop")


p <- plot_dat |> 
    ggplot(aes(dags, hlutf)) +
    geom_hline(yintercept = 1, lty = 2, alpha = 0.6) +
    geom_line(data = plot_dat |> rename(svf = sveitarfelag, teg = tegund), 
              aes(group = paste(svf, teg)), alpha = 0.4, col = "grey50") +
    geom_line(aes(col = sveitarfelag), size = 1.5) +
    geom_rangeframe(sides = "b", aes(alpha = (sveitarfelag == "Seltjarnarnesbær"))) +
    scale_x_date(breaks = seq.Date(from = ymd("2014-01-01"), to = ymd("2022-01-01"), by = "12 month"),
                 date_labels = "%Y", guide = guide_axis(n.dodge = 1)) +
    scale_y_continuous(labels = function(x) percent(x - 1), breaks = c(1, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6)) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    scale_alpha_manual(values = c(0, 1)) +
    facet_grid(sveitarfelag ~ tegund) +
    coord_cartesian(ylim = c(0.9, 1.6)) +
    theme_tufte() +
    theme(legend.position = "none",
          strip.background = element_rect( fill = "grey95"),
          plot.title = element_text(face = "bold")) +
    labs(x = NULL,
         y = NULL,
         title = "Hversu miklu hærra hefur kaupverð verið en fasteignamat?",
         subtitle = "Miðgildi fyrir hlutfallslegan mun sýnt fyrir sveitarfélög Höfuðborgarsvæðisins",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p,
       filename = "kaupverd_hlutf_fasteignamat_manud.png",
       width = 8, height = 1 * 8, scale = 1.3, bg = "white")
```


# Tegund eigenda

```{r}
d <- read_csv2("eigendaskipting.csv") |> 
    janitor::clean_names() |> 
    set_names(c("ar", "logadilar_margar", "logadilar_ein", "einst_margar", "einst_ein"))
```

```{r, fig.width = 10, fig.asp = 0.5}
p <- d |> 
    set_names(c("ar", "Lögaðilar (Margar)", "Lögaðilar (Ein)", "Einstaklingar (Margar)", "Einstaklingar (Ein)")) |> 
    # mutate(adrir = logadilar_margar + einst_margar,
    #        ein = logadilar_ein + einst_ein) |> 
    # select(ar, ein, adrir) |> 
    pivot_longer(c(-ar)) |> 
    group_by(name) |> 
    mutate(value = c(0, diff(value))) |> 
    ungroup() |> 
    filter(ar >= 1995) |>
    mutate(name = fct_relevel(name,
                              "Lögaðilar (Margar)",
                              "Lögaðilar (Ein)",
                              "Einstaklingar (Margar)",
                              "Einstaklingar (Ein)"
    )) |> 
    ggplot(aes(ar, value)) +
    geom_hline(yintercept = 0, lty = 2) +
    geom_col(aes(fill = name), position = "stack", width = 1) +
    scale_x_continuous(expand = expansion(),
                       breaks = c(seq(1994, 2022, by = 2))) +
    scale_y_continuous(expand = expansion()) +
    scale_fill_brewer(type = "div", palette = "RdBu") +
    theme_half_open() +
    theme(legend.position = "top") +
    labs(x = NULL,
         y = NULL,
         fill = NULL,
         title = "Árleg breyting í fjölda fasteigna eftir eignarhaldi",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

ggsave(plot = p, filename = "arleg_breyting_eignarhald.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

```{r, fig.width = 10, fig.asp = 0.5}
plot_dat <- d |> 
    set_names(c("ar", "Lögaðilar (Margar)", "Lögaðilar (Ein)", "Einstaklingar (Margar)", "Einstaklingar (Ein)")) |> 
    # mutate(adrir = logadilar_margar + einst_margar,
    #        ein = logadilar_ein + einst_ein) |> 
    # select(ar, ein, adrir) |> 
    pivot_longer(c(-ar)) |> 
    # group_by(ar) |> 
    # mutate(value = value / sum(value)) |> 
    ungroup() |> 
    group_by(name) |> 
    mutate(value = c(0, diff(value))) |> 
    ungroup() |> 
    filter(ar >= 1995) |>
    mutate(name = fct_relevel(name,
                              "Lögaðilar (Margar)",
                              "Lögaðilar (Ein)",
                              "Einstaklingar (Margar)",
                              "Einstaklingar (Ein)"
    ),
    facet_cols = ifelse(str_detect(name, "Lögaðilar"), "Lögaðilar", "Einstaklingar"),
    facet_rows = ifelse(str_detect(name, "Margar"), "Sem eiga fleiri en eina", "Sem eiga eina")) 


p <- plot_dat |> 
    ggplot(aes(ar, value)) +
    geom_col(data = plot_dat |> rename(nm = name, f1 = facet_cols, f2 = facet_rows), aes(group = nm), fill = "black", position = "stack", width = 1, alpha = 0.2) +
    geom_col(aes(fill = name), position = "stack", width = 1) +
    geom_hline(yintercept = 0, lty = 2) +
    scale_x_continuous(expand = expansion(),
                       breaks = c(seq(1995, 2020, by = 5))) +
    scale_y_continuous(expand = expansion(),
                       labels = label_number()) +
    scale_fill_brewer(type = "div", palette = "RdBu") +
    facet_grid(facet_rows ~ facet_cols) +
    theme_half_open() +
    theme(legend.position = "none", panel.spacing = unit(0.55, "cm")) +
    labs(x = NULL,
         y = NULL,
         fill = NULL,
         title = "Árleg breyting í hlutfalli fasteigna eftir eignarhaldi",
         subtitle = "Sýnt fyrir lögaðila og einstaklinga sem eiga eina eða fleiri en eina fasteign",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

ggsave(plot = p, filename = "arleg_breyting_eignarhald.png",
       width = 8, height = 0.6 * 8, scale = 1.6, bg = "white")
```

```{r, fig.width = 10, fig.asp = 0.5}
plot_dat <- d |> 
    set_names(c("ar", "Lögaðilar (Margar)", "Lögaðilar (Ein)", "Einstaklingar (Margar)", "Einstaklingar (Ein)")) |> 
    # mutate(adrir = logadilar_margar + einst_margar,
    #        ein = logadilar_ein + einst_ein) |> 
    # select(ar, ein, adrir) |> 
    pivot_longer(c(-ar)) |> 
    group_by(ar) |> 
    mutate(value = value / sum(value)) |> 
    ungroup() |> 
    group_by(name) |> 
    mutate(value = c(0, diff(value))) |> 
    ungroup() |> 
    filter(ar >= 1995) |>
    mutate(name = fct_relevel(name,
                              "Lögaðilar (Margar)",
                              "Lögaðilar (Ein)",
                              "Einstaklingar (Margar)",
                              "Einstaklingar (Ein)"
    ),
    facet_cols = ifelse(str_detect(name, "Lögaðilar"), "Lögaðilar", "Einstaklingar"),
    facet_rows = ifelse(str_detect(name, "Margar"), "Sem eiga fleiri en eina", "Sem eiga eina")) 


p <- plot_dat |> 
    ggplot(aes(ar, value)) +
    geom_col(data = plot_dat |> rename(nm = name, f1 = facet_cols, f2 = facet_rows), aes(group = nm), fill = "black", position = "stack", width = 1, alpha = 0.2) +
    geom_col(aes(fill = name), position = "stack", width = 1) +
    geom_hline(yintercept = 0, lty = 2) +
    scale_x_continuous(expand = expansion(),
                       breaks = c(seq(1995, 2020, by = 5))) +
    scale_y_continuous(expand = expansion(),
                       labels = label_percent(),
                       limits = c(-0.02, 0.02)) +
    scale_fill_brewer(type = "div", palette = "RdBu") +
    facet_grid(facet_rows ~ facet_cols) +
    theme_half_open() +
    theme(legend.position = "none", panel.spacing = unit(0.55, "cm")) +
    labs(x = NULL,
         y = NULL,
         fill = NULL,
         title = "Árleg breyting í hlutfalli fasteigna eftir eignarhaldi",
         subtitle = "Sýnt fyrir lögaðila og einstaklinga sem eiga eina eða fleiri en eina fasteign",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

ggsave(plot = p, filename = "arleg_breyting_eignarhaldhlutf.png",
       width = 8, height = 0.6 * 8, scale = 1.6, bg = "white")
```

```{r}
plot_dat <- d |> 
    set_names(c("ar", "logadilar_margar", "logadilar_ein", "einst_margar", "einst_ein")) |> 
    mutate(adrir = logadilar_margar + einst_margar,
           ein = logadilar_ein + einst_ein) |> 
    select(ar, ein, adrir) |> 
    mutate(heild = ein + adrir,
           hlutf = adrir / heild)

p <- plot_dat |> 
    ggplot(aes(ar, hlutf)) +
    geom_line() +
    geom_rangeframe() +
    scale_x_continuous(breaks = c(range(d$ar), 2000, 2005, 2010, 2015)) +
    scale_y_continuous(labels = label_percent(accuracy = 1),
                       breaks = c(range(plot_dat$hlutf), 0.3, 0.27, 0.33)) +
    # coord_cartesian(ylim = c(0.23, 0.38)) +
    theme_tufte() +
    theme(plot.title = element_text(face = "bold")) +
    labs(x = NULL,
         y = NULL,
         title = "Hlutfall fasteigna í eigu einstaklinga eða lögaðila sem eiga fleiri en eina fasteign",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p, filename = "hlutf_eiga_margar.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

```{r}
plot_dat <- d |> 
    set_names(c("ar", "logadilar_margar", "logadilar_ein", "einst_margar", "einst_ein")) |> 
    mutate(adrir = logadilar_margar + einst_margar,
           ein = logadilar_ein + einst_ein) |> 
    select(ar, ein, adrir) |> 
    mutate(heild = ein + adrir,
           hlutf = adrir / heild)

p <- plot_dat |> 
    ggplot(aes(ar, hlutf)) +
    geom_area() +
    geom_rangeframe(data = tibble(ar = c(1994,2022),
                                  hlutf = c(0, 0.36))) +
    scale_x_continuous(breaks = c(range(d$ar), 2000, 2005, 2010, 2015)) +
    scale_y_continuous(labels = label_percent(accuracy = 1),
                       breaks = c(0, 0.1, 0.2, 0.3, 0.36)) +
    # coord_cartesian(ylim = c(0.23, 0.38)) +
    theme_tufte() +
    theme(plot.title = element_text(face = "bold")) +
    labs(x = NULL,
         y = NULL,
         title = "Hlutfall fasteigna í eigu einstaklinga eða lögaðila sem eiga fleiri en eina fasteign",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p, filename = "hlutf_eiga_margar_area.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```


```{r}
plot_dat <- d |> 
    set_names(c("ar", "logadilar_margar", "logadilar_ein", "einst_margar", "einst_ein")) |> 
    mutate(adrir = logadilar_margar + einst_margar,
           ein = logadilar_ein + einst_ein) |> 
    select(ar, "Eiga eina" = ein, "Eiga fleiri en eina" = adrir) |> 
    pivot_longer(c(-ar))

p <- plot_dat |> 
    ggplot(aes(ar, value)) +
    geom_area(aes(fill = name), position = "fill") +
    scale_x_continuous(breaks = c(range(d$ar), 2000, 2005, 2010, 2015),
                       expand = expansion()) +
    scale_y_continuous(labels = label_percent(accuracy = 1),
                       breaks = pretty_breaks(6),
                       expand = expansion()) +
    scale_fill_brewer(type = "div", palette = "Paired")  +
    # coord_cartesian(ylim = c(0.23, 0.38)) +
    theme_half_open() +
    theme(plot.title = element_text(face = "bold"),
          legend.position = "right") +
    labs(x = NULL,
         y = NULL,
         fill = NULL,
         title = "Hlutfall fasteigna eftir eignarhaldi",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p, filename = "hlutf_eignarhald_area.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

```{r}
plot_dat <- d |> 
    set_names(c("ar", "Lögaðilar (Margar)", "Lögaðilar (Ein)", "Einstaklingar (Margar)", "Einstaklingar (Ein)")) |> 
    pivot_longer(c(-ar)) |> 
    mutate(name = fct_relevel(name,
                              "Lögaðilar (Margar)",
                              "Lögaðilar (Ein)",
                              "Einstaklingar (Margar)",
                              "Einstaklingar (Ein)"
    ))

p <- plot_dat |> 
    ggplot(aes(ar, value)) +
    geom_col(aes(fill = name), position = "fill", width = 1) +
    scale_x_continuous(breaks = c(range(d$ar), 2000, 2005, 2010, 2015),
                       expand = expansion()) +
    scale_y_continuous(labels = label_percent(accuracy = 1),
                       breaks = pretty_breaks(6),
                       expand = expansion()) +
    scale_fill_brewer(type = "div", palette = "RdBu") +
    # coord_cartesian(ylim = c(0.23, 0.38)) +
    theme_half_open() +
    theme(plot.title = element_text(face = "bold"),
          legend.position = "top",
          plot.margin = margin(t = 5, r = 20, b = 5, l = 5)) +
    labs(x = NULL,
         y = NULL,
         fill = NULL,
         title = "Hlutfall fasteigna eftir eignarhaldi",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p, filename = "hlutf_allteignarhald_area.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

```{r}
plot_dat <- d |> 
    set_names(c("ar", "Lögaðilar (Margar)", "Lögaðilar (Ein)", "Einstaklingar (Margar)", "Einstaklingar (Ein)")) |> 
    pivot_longer(c(-ar)) |> 
    group_by(ar) |> 
    mutate(hlutf = value / sum(value)) |> 
    ungroup()

p <- plot_dat |> 
    ggplot(aes(ar, hlutf)) +
    geom_line(aes(col = name)) +
    scale_x_continuous(breaks = c(range(d$ar), 2000, 2005, 2010, 2015),
                       expand = expansion()) +
    scale_y_continuous(labels = label_percent(accuracy = 1),
                       breaks = pretty_breaks(6),
                       expand = expansion()) +
    scale_fill_brewer(type = "div", palette = "Paired")  +
    # coord_cartesian(ylim = c(0.23, 0.38)) +
    theme_half_open() +
    theme(plot.title = element_text(face = "bold"),
          legend.position = "top",
          plot.margin = margin(t = 5, r = 20, b = 5, l = 5)) +
    labs(x = NULL,
         y = NULL,
         fill = NULL,
         title = "Hlutfall fasteigna eftir eignarhaldi",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/fasteignafjoldi")

p

ggsave(plot = p, filename = "hlutf_allteignarhald_area.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

# Fjöldi fasteigna frá JSON

```{r, fig.width = 12}
library(rjson)

get_tables <- function(data, years) {
    tibble(
        ar = years,
        svfn = data$svfn,
        sveitarfelag = data$name,
        fjolbyli_fjoldi = data$fjolbyli_fjoldi,
        fjolbyli_medaltal = data$fjolbyli_medaltal,
        fjolbyli_midgildi = data$fjolbyli_midgildi,
        serbyli_fjoldi = data$serbyli_fjoldi,
        serbyli_medaltal = data$serbyli_medaltal,
        serbyli_midgildi = data$serbyli_midgildi,
    ) |> 
        pivot_longer(c(-svfn, -sveitarfelag, -ar), names_to = c("tegund", "breyta"), names_sep = "_") |> 
        mutate(value = ifelse(value == "None", "0", value)) |> 
        pivot_wider(names_from = breyta, values_from = value)
}

d <- fromJSON(file = "https://talnaefni.skra.is/talnaefni/v1/staerdibudasveitarfelog")

d <- d$sveitarfélög |> 
    map(get_tables, years = d$date) |> 
    reduce(bind_rows) |> 
    mutate_at(vars(ar, svfn, fjoldi, medaltal, midgildi), parse_number) |> 
    mutate(sveitarfelag = fct_recode(sveitarfelag,
                                     "Akureyrarkaupstaður" = "Akureyrarbær")) |> 
    inner_join(mannfjoldi,
               by = c("sveitarfelag", "ar")) |> 
    inner_join(
        fjolskyldur |> 
            count(sveitarfelag, ar,
                  wt = fjolskyldur, 
                  name = "fjolskyldur"),
        by =  c("sveitarfelag", "ar")
    )
```


```{r, fig.width = 10}
sveitarfelog <- d |> 
    distinct(sveitarfelag, ar, mannfjoldi) |> 
    filter(ar == max(ar)) |> 
    top_n(9, wt = mannfjoldi)


plot_dat <- d |> 
    semi_join(sveitarfelog, by = "sveitarfelag") |> 
    filter(ar >= 2000, ar < 2022) |> 
    group_by(ar, sveitarfelag, mannfjoldi) |> 
    summarise(fjoldi = sum(fjoldi),
              .groups = "drop") |> 
    mutate(fjoldi_hofdatolu = fjoldi/mannfjoldi * 1000)

plot_dat |> 
    ggplot(aes(ar, fjoldi_hofdatolu)) +
    geom_line(data = plot_dat |> rename(svf = sveitarfelag), aes(group = svf), col = "grey50", alpha = 0.5) +
    geom_line(aes(col = sveitarfelag), size = 1.4) +
    scale_x_continuous() +
    scale_y_continuous() +
    scale_colour_brewer(type = "qual", palette = "Paired") +
    facet_wrap("sveitarfelag") +
    theme_half_open() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL)
```

```{r, fig.width = 10, fig.asp = 0.5}
sveitarfelog <- d |> 
    filter(ar == max(ar)) |> 
    filter(mannfjoldi > 1e3)


plot_dat <- d |> 
    semi_join(sveitarfelog, by = "sveitarfelag") |> 
    filter(ar >= 2010) |> 
    group_by(ar, sveitarfelag, mannfjoldi) |> 
    summarise(fjoldi = sum(fjoldi),
              .groups = "drop") |> 
    mutate(fjoldi_hofdatolu = fjoldi/mannfjoldi * 1000) |> 
    filter(ar >= 2018) |> 
    group_by(sveitarfelag) |> 
    summarise(fjoldi_hofdatolu = sum(fjoldi_hofdatolu),
              .groups = "drop") |> 
    mutate(sveitarfelag = fct_reorder(sveitarfelag, fjoldi_hofdatolu),
           x = ifelse(sveitarfelag == "Dalvíkurbyggð", 18.2, NA_real_),
           text = "Meðaltal á landsvísu")


samtals <- d |> 
    filter(ar >= 2018) |> 
    group_by(ar) |> 
    summarise(mannfjoldi = sum(mannfjoldi),
              fjoldi = sum(fjoldi),
              .groups = "drop") |> 
    mutate(fjoldi_hofdatolu = fjoldi / mannfjoldi * 1000) |> 
    pull(fjoldi_hofdatolu) |> 
    sum()

p <- plot_dat |> 
    ggplot(aes(fjoldi_hofdatolu, sveitarfelag)) +
    geom_vline(xintercept = samtals, lty = 2, alpha = 0.5) +
    geom_segment(aes(xend = 0, yend = sveitarfelag), alpha = 0.5, size = 0.4) +
    geom_point() +
    geom_text(aes(x = x, label = text), hjust = 0, alpha = 0.6) +
    scale_x_continuous(expand = expansion(),
                       labels = label_number(accuracy = 1),
                       limits = c(0, NA),
                       breaks = c(range(plot_dat$fjoldi_hofdatolu), seq(00, 80, by = 10), samtals)) +
    coord_cartesian(clip = "off") +
    theme_half_open() +
    theme(legend.position = "none",
          plot.margin = margin(t = 5, r = 25, b = 5, l = 5)) +
    labs(x = NULL,
         y = NULL,
         title = "Fjöldi nýbyggðra sér- og fjölbýliseigna per 1.000 íbúar frá 2018",
         subtitle = "Sýnt fyrir sveitarfélög með fleiri en 1.000 íbúa árið 2022")

p

ggsave(plot = p, filename = "fjoldi_hofdatolu_2018.png",
       width = 8, height = 0.5 * 8, scale = 1.7, bg = "white")
```


```{r, fig.width = 10, fig.asp = 0.5}
sveitarfelog <- d |> 
    filter(ar == max(ar)) |> 
    filter(mannfjoldi > 1e3)


plot_dat <- d |> 
    semi_join(sveitarfelog, by = "sveitarfelag") |> 
    filter(ar >= 2018) |> 
    group_by(ar, sveitarfelag, mannfjoldi) |> 
    summarise(fjoldi = sum(fjoldi),
              .groups = "drop") |> 
    mutate(fjoldi_hofdatolu = fjoldi/mannfjoldi * 1000) |> 
    group_by(sveitarfelag) |> 
    summarise(fjoldi_hofdatolu = sum(fjoldi_hofdatolu),
              .groups = "drop") |> 
    mutate(sveitarfelag = fct_reorder(sveitarfelag, fjoldi_hofdatolu),
           x = ifelse(sveitarfelag == "Dalvíkurbyggð", 18.2, NA_real_),
           text = "Meðaltal á landsvísu")


samtals <- d |> 
    filter(ar >= 2018) |> 
    group_by(ar) |> 
    summarise(mannfjoldi = sum(mannfjoldi),
              fjoldi = sum(fjoldi),
              .groups = "drop") |> 
    mutate(fjoldi_hofdatolu = fjoldi / mannfjoldi * 1000) |> 
    pull(fjoldi_hofdatolu) |> 
    sum()

p <- plot_dat |> 
    ggplot(aes(fjoldi_hofdatolu, sveitarfelag)) +
    geom_vline(xintercept = samtals, lty = 2, alpha = 0.5) +
    geom_segment(aes(xend = 0, yend = sveitarfelag), alpha = 0.5, size = 0.4) +
    geom_point() +
    geom_text(aes(x = x, label = text), hjust = 0, alpha = 0.6) +
    scale_x_continuous(expand = expansion(),
                       labels = label_number(accuracy = 1),
                       limits = c(0, NA),
                       breaks = c(range(plot_dat$fjoldi_hofdatolu), seq(00, 80, by = 10), samtals)) +
    coord_cartesian(clip = "off") +
    theme_half_open() +
    theme(legend.position = "none",
          plot.margin = margin(t = 5, r = 25, b = 5, l = 5)) +
    labs(x = NULL,
         y = NULL,
         title = "Fjöldi nýbyggðra sér- og fjölbýliseigna per 1.000 íbúar frá 2018",
         subtitle = "Sýnt fyrir sveitarfélög með fleiri en 1.000 íbúa árið 2022")

p

ggsave(plot = p, filename = "fjoldi_hofdatolu_2018.png",
       width = 8, height = 0.5 * 8, scale = 1.7, bg = "white")
```